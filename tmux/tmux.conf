# tmux Configuration - Vesper Theme
# Ghostty as renderer, tmux as window manager

# ===========================
# Prefix Key
# ===========================
# Ghostty translates cmd+shift+space to ctrl+space
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# ===========================
# General Settings
# ===========================
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Allow cursor shape passthrough for vim mode
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'

# Undercurl support for neovim diagnostics
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Allow passthrough for image.nvim
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 100000
set -g escape-time 0
set -g focus-events on
set -g set-clipboard on

# ===========================
# Vi Mode
# ===========================
setw -g mode-keys vi
set -g status-keys vi

# ===========================
# Copy Mode (vim-style)
# ===========================
bind Enter copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle
if-shell "uname | grep -q Darwin" \
    "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'pbcopy'" \
    "bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -selection clipboard'"
bind -T copy-mode-vi Escape send -X cancel

# Word motions
bind -T copy-mode-vi w send -X next-word
bind -T copy-mode-vi b send -X previous-word
bind -T copy-mode-vi e send -X next-word-end

# Line navigation
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line
bind -T copy-mode-vi 0 send -X start-of-line
bind -T copy-mode-vi '$' send -X end-of-line

# Buffer navigation
bind -T copy-mode-vi g send -X history-top
bind -T copy-mode-vi G send -X history-bottom

# Swap cursor position in selection (like o in vim visual)
bind -T copy-mode-vi o send -X other-end

# ===========================
# Pane Navigation (vim-style)
# ===========================
# Pane select with prefix (C-hjkl without prefix covers this via vim-tmux-navigator)
# bind h/j/k/l removed — now used for window nav/reorder below

# Seamless vim-tmux navigation (no prefix, works with vim-tmux-navigator)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# ===========================
# Pane Splitting (vim-style)
# ===========================
# Vim-style: v for vertical (side-by-side), s for horizontal (stacked)
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
# Alternative keys
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# ===========================
# Pane Resizing
# ===========================
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ===========================
# Window Navigation
# ===========================
bind -r h previous-window
bind -r l next-window
bind -r j swap-window -t +1 \; select-window -t +1
bind -r k swap-window -t -1 \; select-window -t -1
bind c new-window -c "#{pane_current_path}"

# Quick window access (Alt+number, no prefix)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ===========================
# Session Management
# ===========================
bind S command-prompt -p "New session:" "new-session -s '%%'"
bind w display-popup -E -w 40% -h 50% 'tmux list-sessions -F "#{session_name}" | fzf --reverse --header="Switch session | C-x: kill" --bind "ctrl-x:execute-silent(tmux kill-session -t {})+reload(tmux list-sessions -F \"#{session_name}\")" | xargs tmux switch-client -t'

# ===========================
# Quick Actions
# ===========================
bind r source-file ~/.tmux.conf \; display "Config reloaded"
bind x kill-pane
bind X kill-window
bind q confirm-before -p "Kill session? (y/n)" kill-session

# ===========================
# Popups and Switchers
# ===========================
# Floating scratch terminal
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Cross-session window switcher (fzf)
bind / display-popup -E -w 40% -h 50% 'tmux list-windows -a -F "#{session_name}:#{window_index}: #{window_name}" | fzf --reverse --header="Switch window" | cut -d: -f1,2 | xargs tmux switch-client -t'

# ===========================
# Help / Keybinding Reference
# ===========================
bind ? display-popup -w 60 -h 40 -E "cat <<'EOF'
        tmux Keybindings (prefix: C-Space)

 COPY MODE
   Enter        Enter copy mode
   v / V / C-v  Select / Line / Block
   y            Yank to clipboard
   w / b / e    Word motions
   0 / $        Start / End of line
   g / G        Top / Bottom of buffer
   o            Swap cursor position
   Escape       Exit copy mode

 PANES
   C-h/j/k/l   Navigate (no prefix, vim-tmux-navigator)
   H J K L      Resize
   v            Split vertical (side-by-side)
   s            Split horizontal (stacked)
   x            Kill pane

 WINDOWS
   c            New window
   h / l        Previous / Next window
   j / k        Reorder window down / up
   Alt+1-9      Jump to window (no prefix)
   X            Kill window

 SESSIONS
   S            New session
   w            Switch session (fzf, C-x kill)
   q            Kill session
   d            Detach

 POPUPS & SEARCH
   g            Scratch terminal popup
   t            tmux-thumbs (copy hints)
   /            Window switcher (fzf)

 OTHER
   r            Reload config
   b            Toggle status bar
   ?            Show this help
EOF"

# ===========================
# Vesper Theme - Status Bar
# ===========================
set -g status off
set -g status-position top
set -g status-justify centre
set -g status-style "bg=#101010,fg=#a0a0a0"

# Left: prefix indicator
set -g status-left-length 20
set -g status-left "#{prefix_highlight}"

# Right: plugins
set -g status-right-length 60
set -g status-right "#{online_status}"

# Window tabs - dots as indicators
setw -g window-status-format "#[fg=#505050] ○ #W "
setw -g window-status-current-format "#[fg=#ffc799] ● #W "
setw -g window-status-separator ""

# Toggle status bar with prefix + b
bind b set -g status

# ===========================
# Pane Borders - Vesper
# ===========================
set -g pane-border-style "fg=#2a2a2a"
set -g pane-active-border-style "fg=#ffc799"

# ===========================
# Message Style
# ===========================
set -g message-style "bg=#ffc799,fg=#101010,bold"
set -g message-command-style "bg=#101010,fg=#ffc799"

# ===========================
# Copy Mode Highlight
# ===========================
setw -g mode-style "bg=#2a2a2a,fg=#ffffff"

# ===========================
# Plugins (TPM)
# ===========================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'fcsonline/tmux-thumbs'

# Prefix highlight
set -g @prefix_highlight_fg '#101010'
set -g @prefix_highlight_bg '#ffc799'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=#101010,bg=#80d9c7'

# Online status
set -g @online_icon "#[fg=#80d9c7]on"
set -g @offline_icon "#[fg=#ff8080]off"

# Session persistence (resurrect + continuum)
set -g @continuum-restore 'on'
set -g @resurrect-capture-pane-contents 'on'

# tmux-thumbs (Vesper colors)
set -g @thumbs-key t
set -g @thumbs-fg-color '#101010'
set -g @thumbs-bg-color '#ffc799'
set -g @thumbs-hint-fg-color '#101010'
set -g @thumbs-hint-bg-color '#80d9c7'
set -g @thumbs-select-fg-color '#101010'
set -g @thumbs-select-bg-color '#ff8080'

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
